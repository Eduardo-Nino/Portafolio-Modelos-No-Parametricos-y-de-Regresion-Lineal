---
title: "Ejercicio 6_Pinguinos Macaroni"
author: "Eduardo Niño Pedraza"
output: 
  pdf_document:
    toc: false
    toc_depth: 2
    fig_width: 5
    fig_height: 3
fontsize: 11pt
geometry: margin=1in
---

```{r setup, include=FALSE}

# Limpiar el entorno
rm(list = ls())

```

Los pinguinos Macaroni ponen nidadas de dos huevos de tamaño diferente. El peso en gramos de los huevos de 11 nidadas se presenta en la tabla de abajo.

```{r Base de datos de pinguinos, echo=FALSE}

#Cargamos las paqueterías necesarias
library(knitr)
library(kableExtra)

#Creamos los vectores con los datos
x = c(79, 93, 100, 105, 101, 96, 96, 109, 70, 71, 87)
y = c(113, 138, 158, 168, 157, 139, 142, 165, 107, 103, 130)

#Los juntamos en un dataframe
Datos = data.frame(cbind(x, y))

#Creamos la tabla con base en los datos anteriores
kable(t(Datos)) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

```

Con base en la información anteriormente proporcionada, los investigadores tienen algunas preguntas, por lo que procedemos de la siguiente manera:

# Inciso 1
Ajuste la recta de regresión para estimar el peso promedio del huevo mayor $(y)$ dado el peso del huevo menor $(x)$. Comente sobre el ajuste del modelo, es decir, si parece correcto y si se cumplen los supuestos.
    
```{r Ajuste del modelo de regresión, include = FALSE}

#Ajustamos el modelo de regresión lineal simple
fit <- lm(y~x, data = Datos)
summary(fit)

```
\textbf{Solución:} Comenzamos nuestro estudio ajustando un modelo de regresión lineal simple usando $y$ y $x$, de donde observamos en primera instancia que le prueba F asociada a la tabla ANOVA indica que existe una relación de algún tipo entre los pesos de las nidadas, $p-value = 1.179e-07<0.05$, posteriormente, observamos que al ser un modelo de regresión lineal simple la prueba que involucra si el coeficiente relacionado a la variable $x$ es cero o no nos indica que es diferente de cero, \textit{p-value = 1.18e-07<0.05}. Además podemos ver que la R cuadrada ajustada nos dan un buen indicio de la variabilidad explicada por el modelo en un $95.7\%$ Así, nuestro modelo ajustado queda de la siguiente manera:
                          
\begin{center}
      $\hat{E}(y;x) = -17.616 +1.702x$
\end{center}

Del modelo ajustado podemos ver que conforme aumenta la masa en gramos de los huevos de la nidada $x$, los huevos de la nidada $y$ aumentan en un factor de 1.702, lo que en efecto se observa en los datos de la base dada. Sin embargo, ahora debemos de revisar los supuestos del modelo, por lo que comenzaremos por homocedasticidad

```{r Verificacion homocedasticidad, echo = FALSE,fig.align='center', fig.cap='Residuos estandarizasos vs valores ajustados',fig.pos='H'}

#Graficamos los valores ajustados contra los errores estandarizados
par(mfrow=c(1,1)) 
par(mar=c(4, 5, 1, 1))
plot(fit, 3)

```
Por parte de la grafica que verifica homocedasticidad no encontramos evidencia en contra, pero procedemos a complementar nuestro análisis visual con pruebas de hipótesis, \textit{Breusch-Pagan test} y \textit{Non-constant Variance Score Test} donde en ambas se contrasta varianza constante contra varianza no constante. De las pruebas de hipótesis reafirmamos las sospechas iniciales pues en ambas no se encuentra evidencia en contra de la homocedasticidad, en BP el $p-value = 0.41 > 0.05$ y en NCV el $p-value = 0.616 > 0.05$. Ahora, debemos de continuar con el supuesto de linealidad

```{r Pruebas de hipotesis homocedasticidad, include = FALSE}

#Prueba de Breusch-Pagan
library(lmtest)
lmtest::bptest(fit)

#Prueba de Non-constant Variance
library(car)
car::ncvTest(fit)

```

```{r Verificacion Linealidad, echo = FALSE,fig.align='center', fig.cap='Residuos vs valores ajustados',fig.pos='H'}

#Graficamos los residuales contra los valores ajustados
par(mfrow=c(1,1)) 
par(mar=c(4, 5, 1, 1))
plot(fit, 1)

```
De la gráfica no podríamos decir que se cumple la linealidad pues no se nota una simetría clara, dado que observamos más residuales negativos que positivos, sin embargo procedemos a hacer pruebas de hipótesis para argumentar la \textbf{no} necesidad de transformación de la variable $x$ usando Box-TidwellDe la prueba obtenemos un $p-value =0.2268 > 0.05$, por lo que no se encuentra evidencia en contra de no tener que usar alguna transformació para $x$, es decir, es plausible considerar el modelo con $x$ directamente.

```{r Pruebas de hipotesis linealidad, include=FALSE}

#De antemano x es positiva, probamos transformaciones tipo Box-Tidwell
library(car)
boxTidwell(y~x, data=Datos)

```

Como siguiente, analizamos la normalidad, aquí cabe hacer notar que dada que nuestra muestra es pequeña (11 observaciones), la QQ plot de la normal puede no ser del todo fiable, aunque no se observan problemas graves de normalidad, pero en dado caso hacemos uso de una QQ plot pero con una distribución $t_{11-3} = t_{8}$, donde observamos nuevamente un comportamiento aceptable para la normalidad

```{r Verificacion Normalidad con distribucion t(n-3), echo=FALSE,fig.align='center', fig.cap='Q-Q plot distribucion t con DF = 8',fig.pos='H'}

library(MASS)
ResStudent <- studres(fit)
df <- length(ResStudent) - 3

# Cuantiles teóricos t
theoretical_q <- qt(ppoints(length(ResStudent)), df)

# QQ plot básico sin etiquetas
qqplot(theoretical_q, ResStudent,
       xlab = paste0("Cuantiles teóricos t(", df, ")"),
       ylab = "Residuos studentizados",
       main = "QQ plot vs t-distribución")

abline(0, 1, col = "red")

```
Apoyandonos de una prueba de hipótesis Kolmogorov-Smirnov no obtenemos evidencia en contra de que nuestros residuos provienen de una distribución t, con $n-3$ grados de libertad, teniendo un $p-value=0.9012> 0.05$

```{r Prueba de hipótesis normalidad, include = FALSE}

#Prueba Kolmogorov-Smirnov 
ks.test(ResStudent, "pt", length(ResStudent)-3)

```
Finalmente, procedemos a revisar el ultimo supuesto respecto a la aleatoriedad de los datos, donde no conocemos nada más que los datos, por lo que corremos las pruebas de hipótesis disponibles. De las pruebas observamos que no se encuentra evidencia en contra de la aleatoriedad, la cual se complementa con el autocorrelograma y las prueba de Durbin-Watson, $p-value = 0.2327$.

```{r Verificación Aleatoriedad, include = FALSE}

#Obtenemos los residuales estandarizados
library(broom)
Datosfit=augment(fit)

#Prueba de rachas y su gráfica
library(lawstat)
lawstat::runs.test(Datosfit$.std.resid, plot.it = TRUE)
library(randtests)
randtests::runs.test(Datosfit$.std.resid)
```
```{r Verificacion Aleatoriedad 2, echo= FALSE,fig.align='center', fig.cap='Autocorrelograma',fig.pos='H'}

#Autocorrelograma de los errores
acf(Datosfit$.std.resid)

```

```{r Verificacion Aleatoriedad 3, include = FALSE}

#Prueba Durbin-Watson
library(lmtest)
lmtest::dwtest(fit, alternative = c("two.sided"))
library(car) 
durbinWatsonTest(fit, max.lag=5)

```

Con base en el análisis anterior nuestro modelo cumple los supuestos y además nos indica una relación creciente entre los valores de $x$ y $y$.

# Inciso 2 

Los investigadores tienen la sospecha de que en promedio se puede decir que la diferencia entre el peso mayor y el peso menor es constante (es decir, no depende del peso del huevo menor observado). Usando el modelo obtenido antes realice una prueba de hipótesis para responder la pregunta de los investigadores, describiendo con detalle las hipótesis que se contrastan.

\textbf{Solución:} Notemos que los investigadores se preguntan si en promedio la diferencia entre el peso del huevo mayor y el menor es constante, es decir que:

\begin{center}
  $ k = E(y;x)-x = \beta_{0}+\beta_{1}x-x = \beta_{0}-(\beta_{1}-1)x$ 
\end{center}

donde para que el lado derecho sea constante, $k = \beta_{0}$ se debe de cumplir que $\beta_{1}-1 = 0$ por lo que nuestra prueba de hipótesis queda establecida de la siguiente manera:

\begin{center}
$H_0 : \beta_1 = 1$ vs $H_a : \beta_1 \neq 1$
\end{center}

```{r Diferencia entre peso mayor y menor, include = FALSE}

# Prueba beta1 = 1 vs beta1 != 1
library(multcomp)
K=matrix(c(0,1), ncol=2, nrow=1, byrow=TRUE)
m=c(1)
summary(glht(fit, linfct=K, rhs=m), test=Ftest())

```

Usando el paquete de Multcomp, y una prueba glht obtenemos un $p-value =0.0001677056 < 0.05$ como evidencia para concluir que $\beta_{1}$ es diferente de $1$, por lo que la sospecha de los investigadores es incorrecta y la diferencia entre el peso mayor y el menor no es constante.

# Inciso 3

Posteriormente se observa el peso de los huevos de una nueva nidada, observándose un peso de 80 y 125 gramos. Usando un intervalo adecuado, comente sobre la sospecha de que la nidada de huevos sí
proviene de pinguinos Macaroni.

\textbf{Solución:} Como en este caso tenemos un peso menor de 80 y uno mayor de 125, lo que los investigadores quieren es saber si con una confianza adecuada podemos decirles si pertenece a las nidadas que fueron observadas, así usando un intervalo de confianza del $95\%$, buscamos el intervalo de confianza con una valor observado de $x=80$, el cual varia de $(114.1202, 122.9458)$ con un valor puntual de $118.533$. Por otro lado, si cambiamos la confianza al $90\%$ tenemos un intervalo de $(114.9571 ,122.1088)$, donde en ambos casos podemos concluir que los huevos de la nueva nidada no son de los pinguinos Macaroni.

```{r Intervalo de confianza, include= FALSE}

# Intervalo de confianza promedio con x=80
newdata <- data.frame(x=c(80))
Eyx80 <- predict(fit,newdata, interval = "confidence", level =0.95)
head(Eyx80)

```

# Conclusiones.

\textbf{Teniendo la información de entre dos nidadas de huevos de pinguinos Macaroni obtenemos un modelo que cumple con los supestos de linealidad, homocedasticidad, normalidad y aleatoriedad. Del modelo concluimos que existe una relación positiva entre el peso del huevo menor y el mayor, descrito por el modelo ajustado:}

\begin{center}
      $\hat{E}(y;x) = -17.616 +1.702x$
\end{center}

\textbf{Además se observa que la diferencia entre el peso mayor y el menor no es constante. Y finalmente si se obtuviera un huevo de peso menor de 80 gramos y uno de peso mayor de 125 podemos concluir que no provienen de una nidada de pinguinos Macaroni.}